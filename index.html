<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OmniAudio Demo Player</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: sans-serif; }
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.7); color: white; cursor: pointer; z-index: 10;
        }
        #overlay h1 { border: 2px solid white; padding: 20px; border-radius: 10px; }
    </style>
</head>
<body>

<div id="overlay">
    <h1>Click to Start Experience</h1>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://www.gstatic.com/external_hosted/omnitone/build/omnitone.min.js"></script>

<script>
    let scene, camera, renderer, controls;
    let video, videoTexture;
    let audioContext, foaDecoder;

    const overlay = document.getElementById('overlay');

    // >>> 在这里修改你的文件路径 <<<
    const VIDEO_SRC = 'video_360.mp4'; // 你的全景视频
    // 如果视频文件里已经包含了4声道Ambisonics音轨，可以不单独加载音频，
    // 但为了演示清晰，这里假设是分离的，或者你需要从 video 标签提取流。
    // 这里我们假设视频静音，音频单独加载（或者视频自带4声道）
    // Omnitone 通常处理 HTMLMediaElement 的音频流。

    overlay.addEventListener('click', init);

    function init() {
        overlay.style.display = 'none';
        initThreeJS();
        initAudio();
    }

    function initThreeJS() {
        // 1. 创建场景
        scene = new THREE.Scene();

        // 2. 创建摄像机
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 0, 0.1); // 摄像机放在球心微偏一点

        // 3. 创建渲染器
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // 4. 创建视频纹理
        video = document.createElement('video');
        video.crossOrigin = 'anonymous';
        video.loop = true;
        video.muted = false; // 声音交给 Omnitone 处理，或者如果是单独音频文件，这里静音
        video.src = VIDEO_SRC;
        video.load();
        
        // 移动端兼容性设置
        video.setAttribute('webkit-playsinline', 'webkit-playsinline'); 
        video.setAttribute('playsinline', 'playsinline');

        videoTexture = new THREE.VideoTexture(video);
        
        // 5. 创建全景球体
        const geometry = new THREE.SphereGeometry(500, 60, 40);
        // 翻转 X 轴，使纹理在球体内部显示正确
        geometry.scale(-1, 1, 1); 
        const material = new THREE.MeshBasicMaterial({ map: videoTexture });
        const sphere = new THREE.Mesh(geometry, material);
        scene.add(sphere);

        // 6. 控制器 (鼠标拖拽)
        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableZoom = false; // 全景通常不缩放
        controls.enablePan = false;
        controls.rotateSpeed = -0.25; // 反转控制方向以符合全景习惯

        // 窗口大小调整
        window.addEventListener('resize', onWindowResize, false);
        
        animate();
    }

    function initAudio() {
        // 初始化 Web Audio API
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioContext = new AudioContext();

        // 初始化 Omnitone FOA Decoder (一阶 Ambisonics 解码器)
        // 默认模式是 'ambisonic-order-1' (4 channels)
        foaDecoder = Omnitone.createFOADecoder(audioContext, video); 

        // 初始化并连接
        foaDecoder.initialize().then(function() {
            video.play();
            console.log('Omnitone initialized and video playing');
        });

        // 如果你的音频是单独的 WAV 文件而不是嵌在视频里的，
        // 你需要创建一个 Audio 标签并传给 createFOADecoder
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
        requestAnimationFrame(animate);
        
        controls.update();

        // >>> 核心逻辑：同步视觉与听觉 <<<
        // 获取摄像机的视图矩阵并传给 Omnitone
        // Omnitone 会根据这个矩阵旋转声场，产生“声音不动，人头动”的效果
        if (foaDecoder && foaDecoder.setRotationMatrix) {
            foaDecoder.setRotationMatrix(camera.matrixWorld.elements);
        }

        renderer.render(scene, camera);
    }
</script>
</body>
</html>